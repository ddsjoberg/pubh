---
title: "Regression Examples"
author: "Josie Athens"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    number_sections: yes
    fig_height: 4
    fig_width: 5
vignette: >
  %\VignetteIndexEntry{Regression Examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", message = FALSE, warning = FALSE)
```

# Introduction

The aim of this vignette is to illustrate the use/functionality of the `glm_coef` function. `glm_coef` can be used to display model coefficients with confidence intervals and p-values. The advantages and limitations of `glm_coef` are:

1. Recognises the main models used in epidemiology/public health.
2. Automatically back transforms estimates and confidence intervals, when the model requires it.
3. Can use robust standard errors for the calculation of confidence intervals.
    - Standard errors are used by default.
    - The use of standard errors is restricted by the following classes of objects (models): `gee`, `glm` and `survreg`.
4. Can display nice labels for the names of the parameters.
5. Returns a data frame that can be modified and/or exported as tables for publications (with further editing).

We start by loading relevant packages and setting the theme for the plots (as suggested in the Template of this package):

```{r, message=FALSE}
library(car, warn.conflicts = FALSE)
library(knitr, warn.conflicts = FALSE)
library(latex2exp, warn.conflicts = FALSE)
library(magrittr, warn.conflicts = FALSE)
library(MASS, warn.conflicts = FALSE)
library(moonBook, warn.conflicts = FALSE)
library(mosaic, warn.conflicts = FALSE)
library(pubh, warn.conflicts = FALSE)

theme_set(theme_sjplot2(base_size = 10))
theme_update(legend.position = "top")
```


# Multiple Linear Regression

For continuous outcomes there is no need of exponentiating the results.


```{r}
data(birthwt)
birthwt <- birthwt %>%
  mutate(
    smoke = factor(smoke, labels = c("Non-smoker", "Smoker")),
    race = factor(race, labels = c("White", "Afican American", "Other"))
    ) %>%
  var_labels(
    bwt = 'Birth weight (g)',
    smoke = 'Smoking status',
    race = 'Race'
    )
```


```{r}
model_norm <- lm(bwt ~ smoke + race, data = birthwt)
```

Traditional output from the model:

```{r}
model_norm %>%
  Anova()
```

```{r}
model_norm %>%
  summary()
```

Table of coefficients:

```{r}
model_norm %>%
  glm_coef()
```

Once we know the order in which the parameters are displayed, we can add labels to our final table:

> **Note:** Compare results using naive and robust standard errors.

```{r}
model_norm %>%
  glm_coef(se_rob = FALSE, labels = c("Constant",
                                      "Smoker - No smoker",
                                      "African American - White",
                                      "Other - White")) %>%
  kable(caption = "Table of coeffients using naive standard errors.",
        align = "r")
```


```{r}
model_norm %>%
  glm_coef(labels = c("Constant",
                      "Smoker - No smoker",
                      "African American - White",
                      "Other - White")) %>%
  kable(caption = "Table of coeffients using robust standard errors.", align = "r")
```

```{r}
tab_model(model_norm, collapse.ci = TRUE)
```

Effect plot:

```{r}
plot_model(model_norm, "pred", terms = race ~ smoke, dot.size = 1, title = "")
```

```{r}
emmip(model_norm, ~ smoke | race, CIs = T) %>%
  gf_labs(y = get_dv_labels(model_norm))
```


# Logistic Regression

For logistic regression we are interested in the odds ratios.

```{r}
data(diet, package = "Epi")
diet <- diet %>%
  var_labels(chd = "Coronary Heart Disease",
             fibre = "Fibre intake (10 g/day)")

model_binom <- glm(chd ~ fibre, data = diet, family = binomial)
```

```{r}
model_binom %>%
  glm_coef(labels = c("Constant", "Fibre intake (g/day)")) %>%
  kable(caption = "Parameter estimates from logistic regression.", align = "r")
```

```{r}
tab_model(model_binom, collapse.ci = TRUE)
```

Effect plot:

```{r}
plot_model(model_binom, "pred", terms="fibre [all]", title = "")
```


## Matched Case-Control Studies: Condtional Logistic Regression

```{r}
data(bdendo, package = "Epi")
levels(bdendo$gall) <- c("No GBD", "GBD")
levels(bdendo$est) <- c("No oestrogen", "Oestrogen")
bdendo <- bdendo %>%
  var_labels(d = "Endometrial cancer",
             est = "Oestrogen user",
             gall = "Gall bladder disease"
             )
```

```{r}
library(survival)
model_clogit <- clogit(d ~ est * gall + strata(set), data = bdendo)
model_clogit %>%
  glm_coef(labels = c("Oestrogen/No oestrogen", "GBD/No GBD",
                      "Oestrogen:GBD Interaction")) %>%
  kable(align = "r")
```

```{r}
tab_model(model_clogit, pred.labels = c("Oestrogen/No oestrogen", "GBD/No GBD",
                      "Oestrogen:GBD Interaction"), collapse.ci = TRUE)
```


```{r}
plot_model(model_clogit, type = "pred", terms = c("est", "gall"), 
           dot.size = 1, title = "")
```



## Ordinal Logistic Regression

```{r}
library(ordinal, warn.conflicts = FALSE)
data(housing)
housing <- housing %>%
  var_labels(Sat = "Satisfaction",
             Infl = "Perceived influence",
             Type = "Type of rental",
             Cont = "Contact")
```

```{r}
model_clm <- clm(Sat ~ Infl + Type + Cont, weights = Freq, data = housing)
glm_coef(model_clm)
```


```{r}
labs_ord <- c("Constant: Low/Medium satisfaction",
              "Constant: Medium/High satisfaction",
              "Perceived influence: Medium/Low",
              "Perceived influence: High/Low",
              "Accommodation: Apartment/Tower",
              "Accommodation: Atrium/Tower",
              "Accommodation: Terrace/Tower",
              "Afforded: High/Low")
kable(glm_coef(model_clm, labels = labs_ord), align = "r", 
      caption = "Parameter estimates on satisfaction of householders.")
```

```{r}
tab_model(model_clm, collapse.ci = TRUE)
```


Effect plot:

```{r}
plot_model(model_clm, dot.size = 1, title = "")
```

```{r}
plot_model(model_clm, type = "pred", terms = c("Infl", "Cont"), 
           dot.size = 1, title = "") %>%
  gf_theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
plot_model(model_clm, type = "pred", terms = c("Infl", "Type"), 
           dot.size = 1, title = "") %>%
  gf_theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
emmip(model_clm, Infl ~ Type |Cont) %>%
  gf_labs(x = "Type of rental", col = "Perceived influence")
```


> **Note:** In tne previous table parameter estimates and confidene intervals for *Perceived influence* and *Accommodation* were not adjusted for multiple comparisons. 

## Multinomial Regression

```{r, message=FALSE}
library(nnet)
model_multi <- multinom(Sat ~ Infl + Type + Cont, weights = Freq, data = housing)
```

```{r}
glm_coef(model_multi)
```


# Poisson Regression

For Poisson regression we are interested in incidence rate ratios.

```{r}
data(quine)
levels(quine$Eth) <- list(White = "N", Aboriginal = "A")
levels(quine$Sex) <- list(Male = "M", Female = "F")
quine <- quine %>%
  var_labels(Days = "Number of absent days",
             Eth = "Ethnicity",
             Age = "Age group")
```

```{r}
model_pois <- glm(Days ~ Eth + Sex + Age, family = poisson, data = quine)
glm_coef(model_pois)
```

```{r}
tab_model(model_pois, collapse.ci = TRUE, show.reflvl = TRUE)
```


## Negative-binomial

The assumption is that the mean is equal than the variance. Is that the case?

```{r}
kable(estat(~ Days|Eth, data = quine, label = "Days of school absences"))
```

> **Note:** Look at the relative dispersion (coefficient of variation), for the variance to be equal to the means the CV would have to be about 35%.

More formally the following calculation should be close to 1:

```{r}
deviance(model_pois) / df.residual(model_pois)
```

Thus, we have over-dispersion. One option is to use a negative binomial distribution.

```{r}
model_negbin <- glm.nb(Days ~ Eth + Sex + Age, data = quine)
unadj <- glm_coef(model_negbin, labels=c("Constant",
                                   "Race: Aboriginal/White",
                                   "Sex: Female/Male",
                                   "F1/Primary",
                                   "F2/Primary",
                                   "F3/Primary"))
```

Notice that age group is a factor with more than two levels and is significant:

```{r}
model_negbin %>%
  Anova()
```

Thus, we want to report confidence intervals and $p$-values adjusted for multiple comparisons.

The unadjusted CIs:

```{r}
kable(unadj, caption = "Parameter estimates with unadjusted CIs and p-values.",
      align = "r")
```

Effect plot:

```{r}
plot_model(model_negbin, type = "pred", terms = c("Age", "Eth"), 
           dot.size = 1, title = "") 
```

## Adjusting CIs and p-values for multiple comparisons

We adjust for multiple comparisons:

```{r}
multiple(model_negbin, ~ Age|Sex)$df
```

We can see the comparison graphically with:

```{r}
multiple(model_negbin, ~ Age|Sex)$fig_ci %>%
  gf_labs(y = "Age group", x = get_label(quine$Days))
```

```{r}
multiple(model_negbin, ~ Age|Sex)$fig_pval %>%
  gf_labs(y = "Age group")
```


```{r}
emmip(model_negbin, Age ~ Sex|Eth, type = 'response') %>%
  gf_labs(y = get_label(quine$Days))
```


# Survival Analysis

```{r}
data(bladder)
bladder <- bladder %>%
  mutate(times = stop,
         rx = factor(rx, labels=c("Placebo", "Thiotepa"))
         ) %>%
  var_labels(times = "Survival time",
             rx = "Treatment")
```

## Parametric method

```{r}
model_surv <- survreg(Surv(times, event) ~ rx, data = bladder)
```

Using robust standard errors (default):

```{r}
model_surv %>%
  glm_coef(labels = c("Treatment: Thiotepa/Placebo", "Scale")) %>%
  kable(align = "r")
```


In this example the scale parameter is not statistically different from one, meaning hazard is constant and thus, we can use the exponential distribution:

```{r}
model_exp <- survreg(Surv(times, event) ~ rx, data = bladder, dist = "exponential")
model_exp %>%
  glm_coef(labels = c("Treatment: Thiotepa/Placebo")) %>%
  kable(align = "r")
```

> **Interpretation:** Patients receiving Thiotepa live on average 64% more than those in the Placebo group.

Using naive standard errors:

```{r}
model_exp %>%
  glm_coef(labels = c("Treatment: Thiotepa/Placebo"), se_rob = FALSE) %>%
  kable(align = "r")
```


```{r}
plot_model(model_exp, type = "pred", terms = ~ rx, dot.size = 1, title = "") %>%
  gf_labs(y = "Survival time", x = "Treatment", title = "")
```


## Cox proportional hazards regression

```{r}
model_cox <-  coxph(Surv(times, event) ~ rx, data = bladder)
```

```{r}
model_cox %>%
  glm_coef(labels = c("Treatment: Thiotepa/Placebo")) %>%
  kable(align = "r")
```

> **Interpretation:** Patients receiving Thiotepa are 64% less likely of dying than those in the Placebo group.

```{r}
plot_model(model_cox, type = "pred", terms = ~ rx, dot.size = 1, 
           title = "") %>%
  gf_labs(x = "Treatment", title = "")
```



# Mixed Linear Regression Models

## Continuous outcomes

```{r}
library(nlme, warn.conflicts = FALSE)
data(Orthodont)
```

```{r}
Orthodont <- Orthodont %>%
  var_labels(distance = "Pituitary distance (mm)",
             age = "Age (years)")
```



```{r}
model_lme <- lme(distance ~ Sex * I(age - mean(age, na.rm = TRUE)), random = ~ 1|Subject, 
                 method = "ML", data = Orthodont)
glm_coef(model_lme)
```

```{r}
model_lme %>%
  glm_coef(labels = c("Constant", "Sex: female-male", "Age (years)",
                      "Sex:Age interaction")) %>%
  kable(align = "r")
```

```{r}
tab_model(model_lme, collapse.ci = TRUE)
```

```{r}
plot_model(model_lme, type = "pred", terms = age ~ Sex) %>%
  gf_labs(y = get_label(Orthodont$distance), x = "Age (years)", title = "")
```

```{r}
emmip(model_lme, age ~ Sex, CIs = TRUE) %>%
  gf_labs(y = get_label(Orthodont$distance))
```


## Count outcomes

```{r}
data(Thall)

c1 <- cbind(Thall[, c(1:5)], count = Thall$y1)[, c(1:4, 6)]
c2 <- cbind(Thall[, c(1:4, 6)], count = Thall$y2)[, c(1:4, 6)]
c3 <- cbind(Thall[, c(1:4, 7)], count = Thall$y3)[, c(1:4, 6)]
c4 <- cbind(Thall[, c(1:4, 8)], count = Thall$y3)[, c(1:4, 6)]
epilepsy <- rbind(c1, c2, c3, c4)
```

```{r}
epilepsy <- epilepsy %>%
  var_labels(count = "Number of events",
             treat = "Treatment",
             base = "Baseline count",
             age = "Age (years)")
```


```{r results = "hide"}
library(lme4, warn.conflicts = FALSE)
model_glmer <- glmer(count ~ treat + base + I(age - mean(age, na.rm = TRUE)) + 
                       (1|id), data=epilepsy, family=poisson)
```

```{r}
model_glmer %>%
  glm_coef(labels = c("Treatment (Prograbide/Control)",
                      "Baseline count", "Age (years)")) %>%
  kable()
```

```{r}
tab_model(model_glmer, collapse.ci = TRUE, show.reflvl = TRUE)
```


Effect plot:

```{r}
plot_model(model_glmer, type = "pred", terms = c("age [15:45]", "treat"), 
           title = "") %>%
  gf_labs(y = "Number of events", x = "Age (years)", col = "Treatment")
```


```{r}
emmip(model_glmer, ~ treat, type = "response", CIs = TRUE) %>%
  gf_labs(y = "Number of events", x = "Treatment")
```

